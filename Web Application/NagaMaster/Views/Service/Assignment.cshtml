@model NagaMaster.Models.Service.AssignmentModel
<div class="header-container fixed-top">
    <header class="header navbar navbar-expand-sm">
        <ul class="navbar-item flex-row">
            <div class="sub-header-container">
                <header class="header navbar navbar-expand-sm">
                    <a href="javascript:void(0);" class="sidebarCollapse" data-placement="bottom">
                        <i class="las la-bars"></i>
                    </a>
                    <ul class="navbar-nav flex-row">
                        <li>
                            <div class="page-header">
                                <nav class="breadcrumb-one" aria-label="breadcrumb">
                                    <ol class="breadcrumb">
                                        <li class="breadcrumb-item active"><a href="javascript:void(0);">Services</a></li>
                                    </ol>
                                </nav>
                            </div>
                        </li>
                    </ul>
                </header>
            </div>
            <li class="heading-nav nav-item dropdown fullscreen-dropdown d-none d-lg-flex">
                @*PlantName :*@ @Request.Cookies["PlantName"].Value.ToString()
            </li>
        </ul>
        <ul class="navbar-item flex-row ml-md-auto">
            <li class="nav-item dropdown fullscreen-dropdown d-none d-lg-flex">
                <a class="nav-link full-screen-mode d-flex align-center" href="javascript:void(0);">
                    <i class="las la-compress pr-2" id="fullScreenIcon"></i>Full Display
                </a>
            </li>
            <li class="nav-item dropdown notification-dropdown">
                <a href="javascript:void(0);" class="nav-link dropdown-toggle position-relative" id="notificationDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="las la-bell"></i>
                    <div class="blink">
                        <div class="circle"></div>
                    </div>
                </a>
                <div class="dropdown-menu position-absolute" aria-labelledby="notificationDropdown">
                    <div class="nav-drop is-notification-dropdown">

                    </div>
                </div>
            </li>
            <li class="nav-item dropdown user-profile-dropdown d-flex align-items-center pr-4">
                <a href="javascript:void(0);" class="nav-link dropdown-toggle user" id="userProfileDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                    <div class="d-flex flex-column text-right">
                        <span class="font-12 strong lh-normal">Welcome! @Request.Cookies["EmpDesc"].Value.ToString()</span>
                        <span class="font-11 lighter lh-normal">@Request.Cookies["RoleName"].Value.ToString()</span>
                    </div>
                    <img src="~/assets/img/new-pizza.jpg" alt="avatar">
                </a>
                <div class="dropdown-menu position-absolute" aria-labelledby="userProfileDropdown">
                    <div class="nav-drop is-account-dropdown">
                        <div class="inner">
                            <div class="nav-drop-body account-items p-0">
                                <a id="profile-link" class="account-item" href="pages_profile.html">
                                    <div class="media align-center">
                                        <div class="media-left">
                                            <div class="image">
                                                <img class="rounded-circle avatar-xs" src="~/assets/img/new-pizza.jpg" alt="">
                                            </div>
                                        </div>
                                        <div class="media-content ml-3">
                                            <h6 class="font-13 mb-0 strong">@Request.Cookies["EmpDesc"].Value.ToString()</h6>
                                            <small>@Request.Cookies["RoleName"].Value.ToString()</small>
                                        </div>
                                        <div class="media-right">
                                            <i data-feather="check"></i>
                                        </div>
                                    </div>
                                </a>
                                <a class="account-item" href="pages_profile.html">
                                    <div class="media align-center">
                                        <div class="icon-wrap">
                                            <i class="las la-user font-20"></i>
                                        </div>
                                        <div class="media-content ml-3">
                                            <h6 class="font-13 mb-0 strong">My Account</h6>
                                        </div>
                                    </div>
                                </a>
                                <a class="account-item" href="pages_timeline.html">
                                    <div class="media align-center">
                                        <div class="icon-wrap">
                                            <i class="las la-briefcase font-20"></i>
                                        </div>
                                        <div class="media-content ml-3">
                                            <h6 class="font-13 mb-0 strong">My Activity</h6>
                                        </div>
                                    </div>
                                </a>
                                <a class="account-item settings">
                                    <div class="media align-center">
                                        <div class="icon-wrap">
                                            <i class="las la-cog font-20"></i>
                                        </div>
                                        <div class="media-content ml-3">
                                            <h6 class="font-13 mb-0 strong">Settings</h6>
                                        </div>
                                    </div>
                                </a>
                                <hr class="account-divider">
                                <a class="account-item" href="~/Login/LoginPage">
                                    <div class="media align-center">
                                        <div class="icon-wrap">
                                            <i class="las la-sign-out-alt font-20"></i>
                                        </div>
                                        <div class="media-content ml-3">
                                            <h6 class="font-13 mb-0 strong ">Logout</h6>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </li>
        </ul>
    </header>
</div>
<!-- Main Body Starts -->
<div class="layout-px-spacing">
    <div class="row layout-top-spacing">
        <div class="col-xl-12 col-lg-12 col-sm-12  layout-spacing">
            <div class="widget-content widget-content-area br-6" style="background: whitesmoke;">
                <form id="frmAssiment">
                    <div class="row mb-2">
                        <div class="col-sm-12">
                            <h4 class="pl-2 pt-2">Assignment</h4>
                            <hr>
                        </div>

                    </div>
                    <div class="assign-input-lane2 row">
                        <div class="col-sm-1"></div>
                        <div class="form-group col-sm-4">
                            <label class="col-form-label">
                                Unit
                            </label>
                            <div class="">
                                @Html.DropDownListFor(x => x.UnitId, new SelectList(Model.UnitDetails, "Value", "Text"), "--- SELECT ---", new { @class = "form-control" })
                            </div>
                        </div>
                        <div class="col-sm-1">

                        </div>
                        <div class="col-sm-1" style="border-left: 1px solid;">

                        </div>
                        <div class="form-group col-sm-4">
                            <label class="col-form-label col-sm-12">Material Description</label>
                            <div class="">
                                @Html.DropDownListFor(x => x.Material, new SelectList(Model.ItemDetails, "Value", "Text"), "--- SELECT ---", new { @class = "form-control", onchange = "LoadItemDetails()" })
                            </div>
                        </div>
                    </div>

                    <div class="assign-input-lane3 row">
                        <div class="col-sm-1"></div>
                        <div class="form-group col-sm-4">
                            <label class="col-form-label">Batch No</label>
                            <div class="">
                                <input class="form-control" type="text" id="BatchNo" name="BatchNo">
                            </div>
                        </div>

                        <div class="col-sm-1">

                        </div>
                        <div class="col-sm-1" style="border-left: 1px solid;">

                        </div>
                        <div class="form-group col-sm-4">
                            <label class="col-form-label col-sm-12">Primary Qty</label>
                            <div class="">
                                <input class="form-control" type="number" id="Primary" name="Primary" onchange="LoadSecondaryQty()" value="">
                            </div>
                        </div>
                    </div>
                    <div class="assign-input-lane3 row">
                        <div class="col-sm-1"></div>
                        <div class="form-group col-sm-4">
                            @*<label class="col-form-label">Batch No</label>*@
                            <div class="">
                                @*<input class="form-control" type="text" id="BatchNo" name="BatchNo">*@
                            </div>
                        </div>

                        <div class="col-sm-1">

                        </div>
                        <div class="col-sm-1" style="border-left: 1px solid;">

                        </div>
                        <div class="form-group col-sm-4">
                            @*<h5 class="mt-0 font-16">Secondary Quantity : </h5>
                                <h5 class="text-primary my-3 text-center"><span name="Target" id="Target"></span></h5>*@


                            <label class="col-form-label col-sm-12">Secondary qty</label>
                            <div class="">
                                <input class="form-control" type="text" disabled id="Targets" name="Targets">
                                <input type="hidden" id="Target" name="Target" value="">
                            </div>
                        </div>
                    </div>

                    <div class="assign-input-lane5 row">
                        <div class="col-sm-12">
                            <hr>
                        </div>
                    </div>

                    <div class="assign-input-lane6 row">
                        <div class="col-sm-2"></div>
                        <div class="form-group col-sm-8 system-check card" style="box-shadow: rgba(50, 50, 93, 0.25) 0px 2px 5px -1px, rgba(0, 0, 0, 0.3) 0px 1px 3px -1px;">
                            <div class="card-header">
                                <label>Select Systems:</label>
                            </div>
                            <div class="checkbox-inline ml-sm-5" style="display: flex;flex-direction:row;justify-content: space-between;align-items: center;height: 50px;">
                                @for (int i = 0; i < Model.SystemDetails.Count(); i++)
                                {
                    <label class="checkbox">
                        <input type="checkbox" name="Systems" class="mr-2" value="@Model.SystemDetails[i].Value">@Model.SystemDetails[i].Text
                    </label>}
                            </div>
                        </div>
                        <div class="col-sm-2"></div>
                    </div>


                    <div class="assign-input-lane7 row">
                        <div class="col-sm-12">
                            <hr>
                        </div>
                    </div>

                    <div class="assign-input-lane10 row">
                        <div class="form-group col-sm-4">

                        </div>
                        @if (ViewBag.IsEdit == 1)
                        {
            <div class="form-group col-sm-4 dayclose">

                <input class="btn btn-success" style="align-items: center;" value="Save" type="button" onclick="funSave()" />
                <input class="btn btn-info" onclick="funclear()" style="align-items: center;" value="Clear" type="button" />

            </div>}
                        @if (ViewBag.IsEdit == 0)
                        {
            <div class="form-group col-sm-4 dayclose">
                <input class="btn btn-success" style="align-items: center;" value="Save" type="button" onclick="ResError()" />
                <input class="btn btn-info" onclick="funclear()" style="align-items: center;" value="Clear" type="button" />
            </div>}
                        <div class="form-group col-sm-4">
                            <input type="hidden" id="Material" value="" name="Material" />
                            <input type="hidden" id="SystemId" value="" name="SystemId" />
                            <input type="hidden" id="PDNId" value="" name="PDNId" />
                        </div>

                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="table-responsive mb-4">
    <table id="tblAssignment" class="table table-hover item-mast " role="grid" style="width:100%">

        <tfoot>
            <tr>
                <th>Sl No</th>
                <th>Date</th>
                <th>Unit</th>
                <th>System</th>
                <th>Material</th>
                <th>BatchNo</th>
                <th>Secondary Qty</th>
                <th>Primary Qty</th>
                <th>Month/Year</th>
            </tr>
        </tfoot>
    </table>
</div>
<!-- Main Body Ends -->

<script>
    function ResError() {
        toastr.error("You are not eligible for generate Assignment");
    }
</script>
<script>

    function funclear() {
        $('#UnitId').val("");
        $('#Material').val("");
        $('#BatchNo').val("");
        $('#Primary').val("");
        $('#Target').val("");
        $('#Target').val("");
        $('#Targets').val("");
        $('input:checkbox').each(function () { this.checked = false; });
    }

    $(document).ready(function () {
        LoadGrid();
    });

    function LoadGrid() {
        var dataset = new Array();
        $.ajax({
            type: "POST",
            url: "/Service/LoadGrid",
            contentType: "application/x-www-form-urlencoded; charset=UTF-8",
            dataType: "json",
            data: $("#frmAssiment").serialize(),
            success: function (response) {
                var jsonData = response.Data;
                console.log(jsonData);
                if (jsonData != null) {
                    len = jsonData.length;
                    console.log(jsonData);
                    if ($.fn.DataTable.fnIsDataTable("#tblAssignment"))
                        $("#tblAssignment").dataTable().fnDestroy();


                    for (i = 0; i < len; i++) {
                        dataset.push([(i + 1), jsonData[i].Date, jsonData[i].UnitName, jsonData[i].System, jsonData[i].Material,
                        jsonData[i].BatchNo, jsonData[i].TargetQty, jsonData[i].PrimaryQty, jsonData[i].MonthYear])

                    }

                    $('#tblAssignment').DataTable({

                        "autoWidth": true,
                        "language": {
                            "paginate": {
                                "previous": "<i class='las la-angle-left'></i>",
                                "next": "<i class='las la-angle-right'></i>"
                            }
                        },
                        data: dataset,
                        columns: [{ title: "Sl No" }, { title: "Date" }, { title: "Unit" }, { title: "System" }, { title: "Material" },
                        { title: "BatchNo" }, { title: "Seondary Qty" }, { title: "Primary Qty" }, { title: "Month/Year" }]
                    });

                } else {
                    alert("something went wrong");
                }
            }
        });
    }

    

    function LoadSecondaryQty() {
        $.ajax({
            type: "POST",
            url: "/Service/GetTargetDetails",
            contentType: "application/x-www-form-urlencoded; charset=UTF-8",
            dataType: "json",
            data: $("#frmAssiment").serialize(),
            success: function (jsonData) {
                console.log(jsonData);
                if (jsonData != null) {

                    if (jsonData.Status == 1) {
                        var input1 = jsonData.Data.Target;
                        var input2 = $("#Primary").val();

                        var result = parseInt(input2 / input1);
                        console.log(input1);
                        $("#Target").val(result);
                        $("#Targets").val(result);
                    }
                    else
                        toastr.error(jsonData.Message);
                }
                else {
                    alert("something went wrong");
                }
            }
        });
    }

    function LoadItemDetails() {
        $.ajax({
            type: "POST",
            url: "/Service/GetBatchDetails",
            contentType: "application/x-www-form-urlencoded; charset=UTF-8",
            dataType: "json",
            data: $("#frmAssiment").serialize(),
            success: function (jsonData) {
                if (jsonData != null) {

                    if (jsonData.Status == 1) {
                        $("#BatchNo").val(jsonData.Data.BatchNo);
                    }
                    else
                        toastr.error(jsonData.Message);
                }
                else {
                    alert("something went wrong");
                }
            }
        });
    }

    function funSave() {
        var systems = '';
        console.log($("#Target").val());
        $('input[name="Systems"]:checked').each(function () {
            console.log(this.value);
            systems += this.value + ',';
        });
        if (systems != '')
            systems = systems.substr(0, systems.length - 1);

        if ($("#UnitId").val() == "") {
            toastr.error("Select Unit");
            return true;
        }
        else if (systems == '') {
            toastr.error("Select System");
            return true;
        }
        else if ($("#Primary").val() == "" || $("#Primary").val() == "0") {
            toastr.error("Input Primary Quantity");
            return true;
        }
        $("#SystemId").val(systems);

        $.ajax({
            type: "POST",
            url: "/Service/SaveAssignment",
            contentType: "application/x-www-form-urlencoded; charset=UTF-8",
            dataType: "json",
            data: $("#frmAssiment").serialize({
                'Target': $("#Target").val(),
            }),
            success: function (jsonData) {
                console.log(jsonData);
                if (jsonData != null) {

                    if (jsonData.Status != 1)
                        toastr.error(jsonData.Message);

                    else {
                        toastr.success(jsonData.Message);
                        setTimeout(function () { location.reload(); }, 2000);

                    }
                } else {
                    alert("something went wrong");
                }
            }
        });
    }
</script>
